(function($,Drupal,drupalSettings,Backbone){'use strict';Drupal.toolbar.ToolbarVisualView=Backbone.View.extend({events:function(){var touchEndToClick=function(event){event.preventDefault();event.target.click();};return{'click .toolbar-bar .toolbar-tab .trigger':'onTabClick','click .toolbar-toggle-orientation button':'onOrientationToggleClick','touchend .toolbar-bar .toolbar-tab .trigger':touchEndToClick,'touchend .toolbar-toggle-orientation button':touchEndToClick};},initialize:function(options){this.strings=options.strings;this.listenTo(this.model,'change:activeTab change:orientation change:isOriented change:isTrayToggleVisible',this.render);this.listenTo(this.model,'change:mqMatches',this.onMediaQueryChange);this.listenTo(this.model,'change:offsets',this.adjustPlacement);this.$el.find('.toolbar-tray .toolbar-lining').append(Drupal.theme('toolbarOrientationToggle'));this.model.trigger('change:activeTab');},render:function(){this.updateTabs();this.updateTrayOrientation();this.updateBarAttributes();if(this.model.changed.orientation==='vertical'||this.model.changed.activeTab){this.loadSubtrees();}
window.setTimeout(function(){Drupal.displace(true);},0);return this;},onTabClick:function(event){if(event.target.hasAttribute('data-toolbar-tray')){var activeTab=this.model.get('activeTab');var clickedTab=event.target;this.model.set('activeTab',(!activeTab||clickedTab!==activeTab)?clickedTab:null);event.preventDefault();event.stopPropagation();}},onOrientationToggleClick:function(event){var orientation=this.model.get('orientation');var antiOrientation=(orientation==='vertical')?'horizontal':'vertical';var locked=antiOrientation==='vertical';if(locked){localStorage.setItem('Drupal.toolbar.trayVerticalLocked','true');}
else{localStorage.removeItem('Drupal.toolbar.trayVerticalLocked');}
this.model.set({locked:locked,orientation:antiOrientation},{validate:true,override:true});event.preventDefault();event.stopPropagation();},updateTabs:function(){var $tab=$(this.model.get('activeTab'));$(this.model.previous('activeTab')).removeClass('is-active').prop('aria-pressed',false);$(this.model.previous('activeTray')).removeClass('is-active');if($tab.length>0){$tab.addClass('is-active').prop('aria-pressed',true);var name=$tab.attr('data-toolbar-tray');var id=$tab.get(0).id;if(id){localStorage.setItem('Drupal.toolbar.activeTabID',JSON.stringify(id));}
var $tray=this.$el.find('[data-toolbar-tray="'+name+'"].toolbar-tray');if($tray.length){$tray.addClass('is-active');this.model.set('activeTray',$tray.get(0));}
else{this.model.set('activeTray',null);}}
else{this.model.set('activeTray',null);localStorage.removeItem('Drupal.toolbar.activeTabID');}},updateBarAttributes:function(){var isOriented=this.model.get('isOriented');if(isOriented){this.$el.find('.toolbar-bar').attr('data-offset-top','');}
else{this.$el.find('.toolbar-bar').removeAttr('data-offset-top');}
this.$el.toggleClass('toolbar-oriented',isOriented);},updateTrayOrientation:function(){var orientation=this.model.get('orientation');var antiOrientation=(orientation==='vertical')?'horizontal':'vertical';var $trays=this.$el.find('.toolbar-tray').removeClass('toolbar-tray-horizontal toolbar-tray-vertical').addClass('toolbar-tray-'+orientation);var iconClass='toolbar-icon-toggle-'+orientation;var iconAntiClass='toolbar-icon-toggle-'+antiOrientation;var $orientationToggle=this.$el.find('.toolbar-toggle-orientation').toggle(this.model.get('isTrayToggleVisible'));$orientationToggle.find('button').val(antiOrientation).attr('title',this.strings[antiOrientation]).text(this.strings[antiOrientation]).removeClass(iconClass).addClass(iconAntiClass);var dir=document.documentElement.dir;var edge=(dir==='rtl')?'right':'left';$trays.removeAttr('data-offset-left data-offset-right data-offset-top');$trays.filter('.toolbar-tray-vertical.is-active').attr('data-offset-'+edge,'');$trays.filter('.toolbar-tray-horizontal.is-active').attr('data-offset-top','');},adjustPlacement:function(){var $trays=this.$el.find('.toolbar-tray');if(!this.model.get('isOriented')){$trays.css('margin-top',0);$trays.removeClass('toolbar-tray-horizontal').addClass('toolbar-tray-vertical');}
else{$trays.css('margin-top',this.$el.find('.toolbar-bar').outerHeight());}},loadSubtrees:function(){var $activeTab=$(this.model.get('activeTab'));var orientation=this.model.get('orientation');if(!this.model.get('areSubtreesLoaded')&&typeof $activeTab.data('drupal-subtrees')!=='undefined'&&orientation==='vertical'){var subtreesHash=drupalSettings.toolbar.subtreesHash;var theme=drupalSettings.ajaxPageState.theme;var endpoint=Drupal.url('toolbar/subtrees/'+subtreesHash);var cachedSubtreesHash=localStorage.getItem('Drupal.toolbar.subtreesHash.'+theme);var cachedSubtrees=JSON.parse(localStorage.getItem('Drupal.toolbar.subtrees.'+theme));var isVertical=this.model.get('orientation')==='vertical';if(isVertical&&subtreesHash===cachedSubtreesHash&&cachedSubtrees){Drupal.toolbar.setSubtrees.resolve(cachedSubtrees);}
else if(isVertical){localStorage.removeItem('Drupal.toolbar.subtreesHash.'+theme);localStorage.removeItem('Drupal.toolbar.subtrees.'+theme);Drupal.ajax({url:endpoint}).execute();localStorage.setItem('Drupal.toolbar.subtreesHash.'+theme,subtreesHash);}}}});}(jQuery,Drupal,drupalSettings,Backbone));