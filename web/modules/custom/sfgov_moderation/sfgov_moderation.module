<?php

/**
 * @file
 * Enhancements to Workflow.
 */

use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\ReplaceCommand;
use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Field\BaseFieldDefinition;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Element;
use Drupal\sfgov_moderation\ModerationUtilServiceInterface;

/**
 * Implements hook_entity_base_field_info().
 */
function sfgov_moderation_entity_base_field_info(EntityTypeInterface $entity_type) {
  if ($entity_type->id() == 'node') {

    $fields['reviewer'] = BaseFieldDefinition::create('entity_reference')
      ->setName('reviewer')
      ->setLabel(t('Reviewer'))
      ->setDescription(t('Assign a user as a reviewer.'))
      ->setSetting('target_type', 'user')
      ->setSetting('handler', 'default')
      ->setDefaultValue(NULL)
      ->setRevisionable(TRUE)
      ->setDisplayOptions('form', [
        'type' => 'options_select',
        'weight' => 100,
      ])
      ->setDisplayOptions('view', [
        'label' => 'hidden',
        'region' => 'hidden',
      ])
      ->setDisplayConfigurable('form', FALSE)
      ->setDisplayConfigurable('view', FALSE);

    return $fields;
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 *
 * BASE_FORM_ID: node_form.
 */
function sfgov_moderation_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  /** @var \Drupal\node\NodeInterface $node */
  $node = $form_state->getFormObject()->getEntity();

  /** @var string $bundle */
  $bundle = $node->bundle();

  /** @var \Drupal\sfgov_moderation\ModerationUtilServiceInterface $moderationUtil */
  $moderationUtil = \Drupal::service('sfgov_moderation.util');

  /** @var string $fieldName */
  $fieldName = $moderationUtil->getDepartmentFieldName($bundle);

  /** @var \Drupal\content_moderation\ModerationInformation $moderation_info */
  $moderation_info = \Drupal::service('content_moderation.moderation_information');

  /** @var \Drupal\Core\Entity\ContentEntityType $entity_type */
  $entity_type = \Drupal::entityTypeManager()->getDefinition('node');

  // If bundle is moderated.
  if ($moderation_info->shouldModerateEntitiesOfBundle($entity_type, $bundle)) {

    // Custom validation callback.
    $form['#validate'][] = '_sfgov_moderation_form_node_form_validate';

    // Move "reviewer" field to the footer region, if available.
    if (isset($form['footer'])) {
      $form['reviewer']['#group'] = 'footer';
    }

    if ($bundle != 'department') {
      // Only show "reviewer" field if a department has been selected.
      $form['reviewer']['widget']['#states'] = [
        'visible' => [
          ':input[name="' . $fieldName . '[0][target_id]"]' => ['filled' => TRUE],
        ],
      ];

      if ($bundle != 'transaction') {

        $departmentIds = $form_state->isRebuilding() ?
          array_column($form_state->getValue($fieldName, []), 'target_id') :
          array_column($node->get($fieldName)->getValue(), 'target_id');

        // Add ajax callback to departments field autocomplete widgets.
        foreach (Element::children($form[$fieldName]['widget']) as $key) {
          if (!is_numeric($key)) {
            continue;
          }

          $form[$fieldName]['widget'][$key]['target_id']['#ajax'] = [
            'callback' => '_sfgov_moderation_departments_callback',
            'event' => 'autocompleteclose changed',
          ];
        }
      }

      else {
        $departmentIds = ['229'];

        $form['data_fetch'] = [
          '#title' => 'Data',
          '#value' => 'Fetch reviewers',
          '#type' => 'submit',
          '#name' =>'sfgov_reviewer_fetch',
          '#ajax' => [
            'callback' => '_sfgov_moderation_departments_callback',
            'event' => 'click',
          ]
        ];
      }
    }
    else {
      $departmentIds = [$node->id()];
    }

    $form['reviewer']['widget']['#options'] = _sfgov_moderation_reviewer_options($departmentIds, $form['reviewer']['widget']['#default_value']);
    $form['reviewer']['widget']['#prefix'] = '<div id="node-reviewer-wrapper">';
    $form['reviewer']['widget']['#suffix'] = '</div>';

  }

  // If bundle is not moderated, disable "reviewer" field.
  else {
    $form['reviewer']['#access'] = FALSE;
  }
}

/**
 * Validation callback for the node form.
 */
function _sfgov_moderation_form_node_form_validate(&$form, FormStateInterface $form_state) {
  /** @var \Drupal\node\NodeInterface $node */
  $node = $form_state->getFormObject()->getEntity();

  /** @var \Drupal\sfgov_moderation\ModerationUtilServiceInterface $moderationUtil */
  $moderationUtil = \Drupal::service('sfgov_moderation.util');

  // Reviewer should not be the same as the node author.
  $reviewer = $form_state->getValue('reviewer');
  if (!empty($reviewer[0]['target_id']) && $reviewer[0]['target_id'] == $node->getOwnerId()) {
    $form_state->setErrorByName('reviewer', t('Reviewer should be a different user than the author.'));
  }

  // Reviewer should belong to the tagged departments.
  $departmentField = $moderationUtil->getDepartmentFieldName($node->bundle());
  $departmentIds = array_column($form_state->getValue($departmentField, []), 'target_id');
  if ($departmentField &&
    !empty($reviewer[0]['target_id']) &&
    $departmentIds) {
    $validReviewers = \Drupal::service('sfgov_moderation.util')->getValidReviewers($departmentIds);
    if (!in_array($reviewer[0]['target_id'], $validReviewers)) {
      $form_state->setErrorByName('reviewer', t('Reviewer should belong to the departments.'));
    }
  }

  // Require selecting a reviewer if departments are tagged in form.
  if (empty($reviewer[0]['target_id']) && !empty($departmentIds)) {
    $currentUser = \Drupal::currentUser();
    $toState = $form_state->getValue('moderation_state')[0]['value'];

    if (
      // State "ready_for_review" always requires selecting a reviewer.
      $toState == 'ready_for_review' ||
      // Only publishers belonging to a node's departments can publish without selecting a reviewer.
      ($toState == 'publish' && !$moderationUtil->canPublishFromDraftWithoutReviewer($currentUser, $departmentIds))
    ) {
      $form_state->setErrorByName('reviewer', t('A reviewer is required to change the moderation status.'));
    }
  }
}

/**
 * Ajax callback whenever the department field changes.
 */
function _sfgov_moderation_departments_callback(&$form, $form_state) {
  $response = new AjaxResponse();
  $response->addCommand(new ReplaceCommand('#node-reviewer-wrapper', $form['reviewer']['widget']));

  return $response;
}

/**
 * Get users that can serve as reviewers.
 *
 * The users need to belong to the given departments.
 *
 * @param array $department_ids
 *   The department node IDs.
 * @param mixed $default_value
 *   The select list default value. It could need to be changed/nulled to avoid
 *   an "invalid value" warning.
 *
 * @return array
 *   The list of reviewers keyed by UID.
 */
function _sfgov_moderation_reviewer_options(array $department_ids = [], &$default_value = NULL) {
  $empty = [
    '_none' => t('- None -'),
  ];

  $ids = \Drupal::service('sfgov_moderation.util')->getValidReviewers($department_ids);

  if (empty($ids)) {
    return $empty;
  }

  $userStorage = \Drupal::entityTypeManager()->getStorage('user');
  $users = $ids ? $userStorage->loadMultiple($ids) : [];
  $default_value = (!empty($default_value) && is_array($default_value) || in_array($default_value[0], $ids)) ? $default_value : NULL;
  $options = $empty;

  foreach ($users as $user) {
    $departments = [];
    foreach ($user->{ModerationUtilServiceInterface::DEPARTMENTS_ACCOUNT_FIELD}->referencedEntities() as $department) {
      $departments[] = $department->label();
    }
    $options[$user->id()] = t('%username (%departments)', [
      '%username' => $user->label(),
      '%departments' => implode(', ', $departments),
    ]);
  }

  return $options;
}

/**
 * Implements hook_views_data_alter().
 */
function sfgov_moderation_views_data_alter(array &$data) {

  $data['node']['latest_moderation_state'] = [
    'title' => t('Latest moderation state'),
    'base' => [
      'field' => 'id',
    ],
    'real field' => 'nid',
    'field' => [
      'title' => t('Latest moderation state'),
      'help' => t('The moderation state of the latest revision.'),
      'id' => 'latest_moderation_state',
      'click sortable' => TRUE,
    ],
  ];
}
