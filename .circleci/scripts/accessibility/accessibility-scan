#!/bin/bash

set -eo pipefail

npm install @axe-core/cli -g

# get the chromedriver version compatible with this image's google chrome version
rm -rf /tmp/chromedriver
mkdir /tmp/chromedriver/
CHROMEDRIVER_VERSION="85.0.4183.87" # current google chrome version in circleci image is 85, cannot sudo to update
CHROMEDRIVER_PATH="/usr/local/bin"
wget -O /tmp/chromedriver/chromedriver.zip 'http://chromedriver.storage.googleapis.com/'$CHROMEDRIVER_VERSION'/chromedriver_linux64.zip'
unzip -o /tmp/chromedriver/chromedriver.zip chromedriver -d $CHROMEDRIVER_PATH

GI_START_URL="$MULTIDEV_SITE_URL"

if [ -n "$CIRCLE_PULL_REQUEST" ]; then
  PR='<'$CIRCLE_PULL_REQUEST'|pr>'
else
  PR='`'$CIRCLE_BRANCH'`'
fi

echo "RESULT_ID from ghost inspector step: $GI_RESULT_ID"

# get the test results from result_id
SUITE_RESULTS=$(curl -s "https://api.ghostinspector.com/v1/suite-results/$GI_RESULT_ID/results/?apiKey=$GI_API_KEY")

TESTS=$(echo $SUITE_RESULTS | jq -r '[ .data[]|{"test_id":"\(.test._id)", "result_id":"\(.suiteResult)", "test_name":"\(.test.name)", "url":"\(.urls | .[-1])", "scan_result":[]}]')

echo $TESTS | jq -c '.[]' | while read i; do
  echo $i | jq -r '"\(.test_id) \(.url)"'
done


URLS=$(echo $TESTS | jq -r '.[] | .url')

echo $URLS

SCAN_OUTPUT=$(axe --stdout $URLS --chromedriver-path "$CHROMEDRIVER_PATH/chromedriver" | jq -jr '.[] | (.url|capture("^(?<a>(?<b>[^:/?#]+):)?(?<c>//(?<d>[^/?#]*))?(?<e>[^?#]*)(?<f>\\?(?<g>[^#]*))?(?<h>#(.*))?")|.e), " (", (.violations|length), " violations)", "\n"')

# SCAN_OUTPUT=$(axe --stdout $URLS | jq -jr '.[] | .url, " (", (.violations|length), " violations)", "\n"')

curl -g -X POST -H 'Content-type: application/json' --data '{"attachments":[{"pretext":":accessibility: accessibility scan complete\n<'$GI_START_URL'|'$GI_START_URL'> | '$PR'","text":"```'"$SCAN_OUTPUT"'```"}]}' $RONBOT_WEBHOOK_URL
